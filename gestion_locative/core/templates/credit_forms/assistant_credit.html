<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Credit Immobilier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .info-box p {
            color: #555;
            font-size: 13px;
            line-height: 1.6;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Etats des champs */
        .form-group.calculated input {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
            font-weight: 600;
        }

        .form-group.needed input {
            border-color: #ff9800;
            background: #fff8e1;
        }

        .form-group.optional input {
            border-color: #e0e0e0;
            background: #fafafa;
        }

        /* Badges d'etat */
        .status-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-calculated {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-needed {
            background: #fff3e0;
            color: #e65100;
        }

        .badge-optional {
            background: #f5f5f5;
            color: #757575;
        }

        .badge-filled {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* Zone de duree */
        .duree-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .duree-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: end;
        }

        .duree-separator {
            font-weight: 600;
            color: #666;
            padding-bottom: 12px;
        }

        /* Resultats */
        .result-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
        }

        .result-box h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .result-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .result-item .label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .result-item .value {
            font-size: 20px;
            font-weight: 700;
        }

        /* Message d'etat */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .status-message.warning {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ffcc80;
        }

        .status-message.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        .status-message .icon {
            font-size: 20px;
        }

        /* Boutons */
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-clear {
            background: transparent;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 15px;
            font-size: 13px;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        /* Legende */
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-color.green { background: #4caf50; }
        .legend-color.orange { background: #ff9800; }
        .legend-color.gray { background: #9e9e9e; }
        .legend-color.blue { background: #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Assistant Credit Immobilier</h1>
            <p>Remplissez les champs que vous connaissez, le reste sera calcule automatiquement</p>
        </header>

        <div class="content">
            <div class="info-box">
                <p><strong>Comment ca marche ?</strong> Entrez les informations dont vous disposez. Le systeme detecte automatiquement ce qui peut etre calcule et indique les donnees manquantes si necessaire.</p>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color blue"></div> Rempli par vous</div>
                <div class="legend-item"><div class="legend-color green"></div> Calcule automatiquement</div>
                <div class="legend-item"><div class="legend-color orange"></div> Necessaire pour calculer</div>
                <div class="legend-item"><div class="legend-color gray"></div> Optionnel</div>
            </div>

            <form id="creditForm" method="POST" action="">
                {% csrf_token %}

                <!-- Informations generales -->
                <div class="section-title">Informations generales</div>
                <div class="form-grid">
                    <div class="form-group" id="group-immeuble">
                        <label for="immeuble">Immeuble *</label>
                        <select id="immeuble" name="immeuble" required>
                            <option value="">-- Selectionner --</option>
                            {% for immeuble in immeubles %}
                            <option value="{{ immeuble.id }}" {% if selected_immeuble_id == immeuble.id %}selected{% endif %}>{{ immeuble.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group" id="group-banque">
                        <label for="nom_banque">Banque *</label>
                        <input type="text" id="nom_banque" name="nom_banque" required placeholder="Ex: Credit Agricole">
                    </div>

                    <div class="form-group" id="group-numero">
                        <label for="numero_pret">Numero de pret <span class="status-badge badge-optional">optionnel</span></label>
                        <input type="text" id="numero_pret" name="numero_pret" placeholder="Reference du pret">
                    </div>

                    <div class="form-group" id="group-type">
                        <label for="type_credit">Type de credit *</label>
                        <select id="type_credit" name="type_credit" required>
                            <option value="AMORTISSABLE">Amortissable</option>
                            <option value="IN_FINE">In Fine</option>
                        </select>
                    </div>
                </div>

                <!-- Donnees du credit -->
                <div class="section-title">Donnees du credit (remplissez ce que vous connaissez)</div>

                <div class="form-grid">
                    <div class="form-group" id="group-capital">
                        <label for="capital_emprunte">
                            Capital emprunte (euros)
                            <span class="status-badge" id="badge-capital"></span>
                        </label>
                        <input type="number" id="capital_emprunte" name="capital_emprunte" step="0.01" placeholder="Ex: 150000">
                    </div>

                    <div class="form-group" id="group-taux">
                        <label for="taux_interet">
                            Taux d'interet (%)
                            <span class="status-badge" id="badge-taux"></span>
                        </label>
                        <input type="number" id="taux_interet" name="taux_interet" step="0.001" placeholder="Ex: 1.5">
                    </div>

                    <div class="form-group" id="group-mensualite">
                        <label for="mensualite">
                            Mensualite hors assurance (euros)
                            <span class="status-badge" id="badge-mensualite"></span>
                        </label>
                        <input type="number" id="mensualite" step="0.01" placeholder="Ex: 750">
                    </div>

                    <div class="form-group" id="group-assurance">
                        <label for="assurance_mensuelle">
                            Assurance mensuelle (euros)
                            <span class="status-badge badge-optional">optionnel</span>
                        </label>
                        <input type="number" id="assurance_mensuelle" name="assurance_mensuelle" step="0.01" value="0" placeholder="Ex: 30">
                    </div>
                </div>

                <!-- Duree -->
                <div class="section-title">Duree du credit</div>
                <div class="duree-container">
                    <div class="duree-row">
                        <div class="form-group" id="group-date-debut">
                            <label for="date_debut">
                                Date de debut *
                                <span class="status-badge" id="badge-date-debut"></span>
                            </label>
                            <input type="date" id="date_debut" name="date_debut" required>
                        </div>

                        <div class="duree-separator">ou</div>

                        <div class="form-group" id="group-duree">
                            <label for="duree_mois">
                                Duree (mois)
                                <span class="status-badge" id="badge-duree"></span>
                            </label>
                            <input type="number" id="duree_mois" name="duree_mois" placeholder="Ex: 240">
                        </div>
                    </div>
                    <div class="duree-row" style="margin-top: 15px;">
                        <div></div>
                        <div class="duree-separator">ou</div>
                        <div class="form-group" id="group-date-fin">
                            <label for="date_fin">
                                Date de fin
                                <span class="status-badge" id="badge-date-fin"></span>
                            </label>
                            <input type="date" id="date_fin">
                        </div>
                    </div>
                </div>

                <!-- Capital restant du (optionnel, pour credit en cours) -->
                <div class="section-title">Credit en cours (optionnel)</div>
                <div class="info-box" style="margin-bottom: 15px;">
                    <p>Si vous avez un credit en cours et connaissez le capital restant du actuel, renseignez-le ici. Cela permet de calculer le taux et/ou le capital initial.</p>
                </div>
                <div class="form-grid">
                    <div class="form-group" id="group-crd">
                        <label for="capital_restant">
                            Capital restant du actuel (euros)
                            <span class="status-badge badge-optional">optionnel</span>
                        </label>
                        <input type="number" id="capital_restant" step="0.01" placeholder="Capital restant a rembourser">
                    </div>
                </div>

                <!-- Message d'etat -->
                <div id="statusMessage" class="status-message info" style="display: none;">
                    <span class="icon"></span>
                    <span class="text"></span>
                </div>

                <!-- Resultats -->
                <div class="result-box" id="resultsBox" style="display: none;">
                    <h3>Recapitulatif du credit</h3>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">Capital emprunte</div>
                            <div class="value" id="result-capital">-</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Taux d'interet</div>
                            <div class="value" id="result-taux">-</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Duree</div>
                            <div class="value" id="result-duree">-</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Mensualite</div>
                            <div class="value" id="result-mensualite">-</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Cout total</div>
                            <div class="value" id="result-cout">-</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Date de fin</div>
                            <div class="value" id="result-date-fin">-</div>
                        </div>
                    </div>
                </div>

                <!-- Champs hidden pour l'envoi -->
                <input type="hidden" id="hidden_capital" name="capital_emprunte_final">
                <input type="hidden" id="hidden_taux" name="taux_interet_final">
                <input type="hidden" id="hidden_duree" name="duree_mois_final">

                <div class="button-group">
                    <button type="button" class="btn btn-clear" onclick="clearForm()">Effacer tout</button>
                    <div>
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">Annuler</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>Enregistrer le credit</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables pour stocker l'etat
        let values = {
            capital: null,
            taux: null,
            duree: null,
            mensualite: null,
            dateDebut: null,
            dateFin: null,
            crd: null
        };

        let calculated = {
            capital: false,
            taux: false,
            duree: false,
            mensualite: false,
            dateFin: false
        };

        // Fonctions de calcul
        function calculateMensualite(capital, taux, duree, typeCredit) {
            if (!capital || !duree || taux === null || taux === undefined) return null;
            const tauxMensuel = taux / 100 / 12;
            if (typeCredit === 'IN_FINE') return capital * tauxMensuel;
            if (tauxMensuel === 0) return capital / duree;
            return capital * (tauxMensuel * Math.pow(1 + tauxMensuel, duree)) / (Math.pow(1 + tauxMensuel, duree) - 1);
        }

        function calculateCapital(mensualite, taux, duree, typeCredit) {
            if (!mensualite || !duree || taux === null || taux === undefined) return null;
            const tauxMensuel = taux / 100 / 12;
            if (typeCredit === 'IN_FINE') return tauxMensuel > 0 ? mensualite / tauxMensuel : null;
            if (tauxMensuel === 0) return mensualite * duree;
            return mensualite * (Math.pow(1 + tauxMensuel, duree) - 1) / (tauxMensuel * Math.pow(1 + tauxMensuel, duree));
        }

        function calculateTaux(capital, mensualite, duree, typeCredit) {
            if (!capital || !mensualite || !duree) return null;
            if (typeCredit === 'IN_FINE') return (mensualite / capital) * 12 * 100;

            let taux = 0.05;
            const tolerance = 0.0001;
            const maxIterations = 100;

            for (let i = 0; i < maxIterations; i++) {
                const tauxMensuel = taux / 12;
                if (tauxMensuel <= 0) { taux = 0.001; continue; }

                const mensCalc = capital * (tauxMensuel * Math.pow(1 + tauxMensuel, duree)) / (Math.pow(1 + tauxMensuel, duree) - 1);
                if (Math.abs(mensCalc - mensualite) < tolerance) return taux * 100;

                const epsilon = 0.0001;
                const mensPlus = capital * ((tauxMensuel + epsilon) * Math.pow(1 + tauxMensuel + epsilon, duree)) / (Math.pow(1 + tauxMensuel + epsilon, duree) - 1);
                const derivee = (mensPlus - mensCalc) / epsilon;
                if (derivee !== 0) taux = taux - (mensCalc - mensualite) / derivee;
                if (taux < 0) taux = 0.001;
            }
            return taux * 100;
        }

        function calculateDureeFromDates(dateDebut, dateFin) {
            if (!dateDebut || !dateFin) return null;
            const d1 = new Date(dateDebut);
            const d2 = new Date(dateFin);
            const months = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
            return months > 0 ? months : null;
        }

        function calculateDateFin(dateDebut, dureeMois) {
            if (!dateDebut || !dureeMois) return null;
            const d = new Date(dateDebut);
            d.setMonth(d.getMonth() + parseInt(dureeMois));
            return d.toISOString().split('T')[0];
        }

        function calculateDureeRestante(dateFin) {
            if (!dateFin) return null;
            const today = new Date();
            const d2 = new Date(dateFin);
            const months = (d2.getFullYear() - today.getFullYear()) * 12 + (d2.getMonth() - today.getMonth());
            return months > 0 ? months : null;
        }

        function formatDuree(mois) {
            const annees = Math.floor(mois / 12);
            const moisRestants = mois % 12;
            if (annees === 0) return mois + ' mois';
            if (moisRestants === 0) return annees + ' ans';
            return annees + 'a ' + moisRestants + 'm';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR');
        }

        // Lire les valeurs des champs
        function readValues() {
            const capitalInput = document.getElementById('capital_emprunte').value;
            const tauxInput = document.getElementById('taux_interet').value;
            const mensualiteInput = document.getElementById('mensualite').value;
            const dureeInput = document.getElementById('duree_mois').value;
            const dateDebutInput = document.getElementById('date_debut').value;
            const dateFinInput = document.getElementById('date_fin').value;
            const crdInput = document.getElementById('capital_restant').value;

            return {
                capital: capitalInput ? parseFloat(capitalInput) : null,
                taux: tauxInput ? parseFloat(tauxInput) : null,
                mensualite: mensualiteInput ? parseFloat(mensualiteInput) : null,
                duree: dureeInput ? parseInt(dureeInput) : null,
                dateDebut: dateDebutInput || null,
                dateFin: dateFinInput || null,
                crd: crdInput ? parseFloat(crdInput) : null
            };
        }

        // Mettre a jour les badges
        function updateBadge(id, state, text) {
            const badge = document.getElementById(id);
            const group = badge.closest('.form-group');

            badge.className = 'status-badge';
            group.className = 'form-group';

            if (state === 'calculated') {
                badge.classList.add('badge-calculated');
                badge.textContent = 'calcule';
                group.classList.add('calculated');
            } else if (state === 'needed') {
                badge.classList.add('badge-needed');
                badge.textContent = text || 'necessaire';
                group.classList.add('needed');
            } else if (state === 'filled') {
                badge.classList.add('badge-filled');
                badge.textContent = 'rempli';
            } else if (state === 'optional') {
                badge.classList.add('badge-optional');
                badge.textContent = 'optionnel';
                group.classList.add('optional');
            } else {
                badge.textContent = '';
            }
        }

        // Fonction principale de calcul
        function calculate() {
            const input = readValues();
            const typeCredit = document.getElementById('type_credit').value;

            // Reset calculated flags
            calculated = { capital: false, taux: false, duree: false, mensualite: false, dateFin: false };

            let capital = input.capital;
            let taux = input.taux;
            let duree = input.duree;
            let mensualite = input.mensualite;
            let dateFin = input.dateFin;
            let dateDebut = input.dateDebut;
            let crd = input.crd;

            // Calculer duree a partir des dates si non fournie
            if (!duree && dateDebut && dateFin) {
                duree = calculateDureeFromDates(dateDebut, dateFin);
                if (duree) calculated.duree = true;
            }

            // Calculer date de fin a partir de duree si non fournie
            if (!dateFin && dateDebut && duree) {
                dateFin = calculateDateFin(dateDebut, duree);
                if (dateFin) calculated.dateFin = true;
            }

            // Si on a le CRD, mensualite et date de fin, on peut calculer le taux
            if (crd && mensualite && dateFin && !taux) {
                const dureeRestante = calculateDureeRestante(dateFin);
                if (dureeRestante) {
                    taux = calculateTaux(crd, mensualite, dureeRestante, typeCredit);
                    if (taux) calculated.taux = true;
                }
            }

            // Cas 1: Capital + Taux + Duree -> Mensualite
            if (capital && taux !== null && duree && !mensualite) {
                mensualite = calculateMensualite(capital, taux, duree, typeCredit);
                if (mensualite) calculated.mensualite = true;
            }

            // Cas 2: Mensualite + Taux + Duree -> Capital
            if (mensualite && taux !== null && duree && !capital) {
                capital = calculateCapital(mensualite, taux, duree, typeCredit);
                if (capital) calculated.capital = true;
            }

            // Cas 3: Capital + Mensualite + Duree -> Taux
            if (capital && mensualite && duree && taux === null) {
                taux = calculateTaux(capital, mensualite, duree, typeCredit);
                if (taux !== null) calculated.taux = true;
            }

            // Stocker les valeurs finales
            values = { capital, taux, duree, mensualite, dateDebut, dateFin, crd };

            // Mettre a jour l'interface
            updateUI(input);
        }

        function updateUI(input) {
            const { capital, taux, duree, mensualite, dateFin, dateDebut } = values;
            const assurance = parseFloat(document.getElementById('assurance_mensuelle').value) || 0;

            // Mettre a jour les badges
            if (calculated.capital) {
                updateBadge('badge-capital', 'calculated');
                document.getElementById('capital_emprunte').value = capital.toFixed(2);
            } else if (input.capital) {
                updateBadge('badge-capital', 'filled');
            } else if (taux !== null && duree && mensualite) {
                updateBadge('badge-capital', 'optional');
            } else {
                updateBadge('badge-capital', 'needed');
            }

            if (calculated.taux) {
                updateBadge('badge-taux', 'calculated');
                document.getElementById('taux_interet').value = taux.toFixed(3);
            } else if (input.taux !== null) {
                updateBadge('badge-taux', 'filled');
            } else if (capital && duree && mensualite) {
                updateBadge('badge-taux', 'optional');
            } else {
                updateBadge('badge-taux', 'needed');
            }

            if (calculated.mensualite) {
                updateBadge('badge-mensualite', 'calculated');
                document.getElementById('mensualite').value = mensualite.toFixed(2);
            } else if (input.mensualite) {
                updateBadge('badge-mensualite', 'filled');
            } else if (capital && taux !== null && duree) {
                updateBadge('badge-mensualite', 'optional');
            } else {
                updateBadge('badge-mensualite', 'needed');
            }

            if (calculated.duree) {
                updateBadge('badge-duree', 'calculated');
                document.getElementById('duree_mois').value = duree;
            } else if (input.duree) {
                updateBadge('badge-duree', 'filled');
            } else if (input.dateDebut && input.dateFin) {
                updateBadge('badge-duree', 'optional');
            } else {
                updateBadge('badge-duree', 'needed');
            }

            if (input.dateDebut) {
                updateBadge('badge-date-debut', 'filled');
            } else {
                updateBadge('badge-date-debut', 'needed');
            }

            if (calculated.dateFin) {
                updateBadge('badge-date-fin', 'calculated');
                document.getElementById('date_fin').value = dateFin;
            } else if (input.dateFin) {
                updateBadge('badge-date-fin', 'filled');
            } else if (input.dateDebut && duree) {
                updateBadge('badge-date-fin', 'optional');
            } else {
                updateBadge('badge-date-fin', 'optional');
            }

            // Verifier si on a toutes les donnees necessaires
            const isComplete = capital && taux !== null && duree && mensualite && dateDebut;
            const submitBtn = document.getElementById('submitBtn');
            const resultsBox = document.getElementById('resultsBox');
            const statusMessage = document.getElementById('statusMessage');

            if (isComplete) {
                submitBtn.disabled = false;
                resultsBox.style.display = 'block';

                const mensualiteTotale = mensualite + assurance;
                const coutTotal = mensualiteTotale * duree;

                document.getElementById('result-capital').textContent = Math.round(capital).toLocaleString('fr-FR') + ' euros';
                document.getElementById('result-taux').textContent = taux.toFixed(2) + ' %';
                document.getElementById('result-duree').textContent = formatDuree(duree);
                document.getElementById('result-mensualite').textContent = mensualiteTotale.toFixed(2) + ' euros';
                document.getElementById('result-cout').textContent = Math.round(coutTotal).toLocaleString('fr-FR') + ' euros';
                document.getElementById('result-date-fin').textContent = formatDate(dateFin);

                // Remplir les champs hidden
                document.getElementById('hidden_capital').value = capital.toFixed(2);
                document.getElementById('hidden_taux').value = taux.toFixed(3);
                document.getElementById('hidden_duree').value = duree;

                statusMessage.className = 'status-message success';
                statusMessage.querySelector('.icon').textContent = 'âœ“';
                statusMessage.querySelector('.text').textContent = 'Toutes les donnees sont completes. Vous pouvez enregistrer le credit.';
                statusMessage.style.display = 'flex';
            } else {
                submitBtn.disabled = true;
                resultsBox.style.display = 'none';

                // Determiner ce qui manque
                let missing = [];
                if (!dateDebut) missing.push('date de debut');
                if (!duree && !input.dateFin) missing.push('duree ou date de fin');
                if (!capital && !input.capital) missing.push('capital');
                if (taux === null && input.taux === null) missing.push('taux');
                if (!mensualite && !input.mensualite) missing.push('mensualite');

                if (missing.length > 0) {
                    statusMessage.className = 'status-message warning';
                    statusMessage.querySelector('.icon').textContent = '!';
                    statusMessage.querySelector('.text').textContent = 'Donnees manquantes : ' + missing.join(', ');
                    statusMessage.style.display = 'flex';
                } else {
                    statusMessage.className = 'status-message info';
                    statusMessage.querySelector('.icon').textContent = 'i';
                    statusMessage.querySelector('.text').textContent = 'Entrez les donnees que vous connaissez pour calculer les autres.';
                    statusMessage.style.display = 'flex';
                }
            }
        }

        // Effacer le formulaire
        function clearForm() {
            document.getElementById('capital_emprunte').value = '';
            document.getElementById('taux_interet').value = '';
            document.getElementById('mensualite').value = '';
            document.getElementById('duree_mois').value = '';
            document.getElementById('date_debut').value = '';
            document.getElementById('date_fin').value = '';
            document.getElementById('capital_restant').value = '';
            document.getElementById('assurance_mensuelle').value = '0';
            calculate();
        }

        // Ecouter les changements
        document.querySelectorAll('input[type="number"], input[type="date"], select#type_credit').forEach(input => {
            input.addEventListener('input', calculate);
            input.addEventListener('change', calculate);
        });

        // Validation avant soumission
        document.getElementById('creditForm').addEventListener('submit', function(e) {
            const { capital, taux, duree } = values;
            const dateDebut = document.getElementById('date_debut').value;

            if (!capital || taux === null || !duree || !dateDebut) {
                e.preventDefault();
                alert('Veuillez remplir toutes les donnees necessaires.');
                return false;
            }

            // Mettre les bonnes valeurs dans les champs du formulaire
            document.getElementById('capital_emprunte').value = capital.toFixed(2);
            document.getElementById('taux_interet').value = taux.toFixed(3);
            document.getElementById('duree_mois').value = duree;
        });

        // Initialiser
        calculate();
    </script>
</body>
</html>
