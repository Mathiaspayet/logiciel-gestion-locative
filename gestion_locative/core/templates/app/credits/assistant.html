{% extends "app/base.html" %}
{% load app_filters %}

{% block title %}Assistant Credit - {{ immeuble.nom }}{% endblock %}
{% block page_title %}
<div class="flex items-center gap-2">
    <a href="{% url 'app_immeuble_detail' pk=immeuble.pk %}" class="text-gray-400 hover:text-gray-600">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    </a>
    Nouveau credit - {{ immeuble.nom }}
</div>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    <!-- Info box -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <div class="flex gap-3">
            <svg class="w-5 h-5 text-blue-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <div>
                <p class="text-sm font-medium text-blue-900">Remplissez les champs que vous connaissez</p>
                <p class="text-sm text-blue-700 mt-1">L'assistant calcule automatiquement les valeurs manquantes. Parmi <strong>capital</strong>, <strong>taux</strong>, <strong>duree</strong> et <strong>mensualite</strong>, renseignez-en au moins 3 et le 4e sera calcule.</p>
            </div>
        </div>
    </div>

    <!-- Legende -->
    <div class="flex flex-wrap gap-4 mb-6 text-xs">
        <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span> Rempli par vous</span>
        <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-green-500"></span> Calcule automatiquement</span>
        <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-amber-500"></span> Necessaire</span>
        <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-gray-300"></span> Optionnel</span>
    </div>

    <form id="creditForm" method="POST">
        {% csrf_token %}

        <!-- Section: Informations generales -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-5">
            <div class="px-5 py-3 border-b border-gray-100">
                <h2 class="text-sm font-semibold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    Informations generales
                </h2>
            </div>
            <div class="p-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Banque <span class="text-red-500">*</span></label>
                    <input type="text" id="nom_banque" name="nom_banque" required
                           class="w-full rounded-lg border-gray-300 border px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                           placeholder="Ex: Credit Agricole">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Numero de pret <span class="text-xs text-gray-400">(optionnel)</span></label>
                    <input type="text" id="numero_pret" name="numero_pret"
                           class="w-full rounded-lg border-gray-300 border px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                           placeholder="Reference du pret">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type de credit <span class="text-red-500">*</span></label>
                    <select id="type_credit" name="type_credit" required
                            class="w-full rounded-lg border-gray-300 border px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="AMORTISSABLE">Amortissable</option>
                        <option value="IN_FINE">In Fine</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Section: Donnees financieres -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-5">
            <div class="px-5 py-3 border-b border-gray-100">
                <h2 class="text-sm font-semibold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
                    Donnees financieres
                </h2>
            </div>
            <div class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-5">
                <!-- Capital emprunte -->
                <div id="group-capital" class="relative">
                    <label class="text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                        <span>Capital emprunte</span>
                        <span id="badge-capital" class="text-[10px] font-semibold px-2 py-0.5 rounded-full"></span>
                    </label>
                    <div class="relative">
                        <input type="number" id="capital_emprunte" name="capital_emprunte" step="0.01" min="0"
                               class="w-full rounded-lg border px-3 py-2.5 text-sm pr-10 transition field-input"
                               placeholder="Ex: 150 000">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-gray-400">EUR</span>
                    </div>
                </div>

                <!-- Taux interet -->
                <div id="group-taux" class="relative">
                    <label class="text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                        <span>Taux d'interet</span>
                        <span id="badge-taux" class="text-[10px] font-semibold px-2 py-0.5 rounded-full"></span>
                    </label>
                    <div class="relative">
                        <input type="number" id="taux_interet" name="taux_interet" step="0.001" min="0"
                               class="w-full rounded-lg border px-3 py-2.5 text-sm pr-8 transition field-input"
                               placeholder="Ex: 1.5">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-gray-400">%</span>
                    </div>
                </div>

                <!-- Mensualite hors assurance -->
                <div id="group-mensualite" class="relative">
                    <label class="text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                        <span>Mensualite hors assurance</span>
                        <span id="badge-mensualite" class="text-[10px] font-semibold px-2 py-0.5 rounded-full"></span>
                    </label>
                    <div class="relative">
                        <input type="number" id="mensualite" step="0.01" min="0"
                               class="w-full rounded-lg border px-3 py-2.5 text-sm pr-10 transition field-input"
                               placeholder="Ex: 750">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-gray-400">EUR</span>
                    </div>
                </div>

                <!-- Assurance mensuelle -->
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                        <span>Assurance mensuelle</span>
                        <span class="text-[10px] font-semibold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">optionnel</span>
                    </label>
                    <div class="relative">
                        <input type="number" id="assurance_mensuelle" name="assurance_mensuelle" step="0.01" min="0" value="0"
                               class="w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm pr-10 transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Ex: 30">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-gray-400">EUR</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Duree -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-5">
            <div class="px-5 py-3 border-b border-gray-100">
                <h2 class="text-sm font-semibold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    Duree du credit
                </h2>
            </div>
            <div class="p-5">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-5 items-end">
                    <div>
                        <label class="text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                            <span>Date de debut <span class="text-red-500">*</span></span>
                            <span id="badge-date-debut" class="text-[10px] font-semibold px-2 py-0.5 rounded-full"></span>
                        </label>
                        <input type="date" id="date_debut" name="date_debut" required
                               class="w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div id="group-duree">
                        <label class="text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                            <span>Duree (mois)</span>
                            <span id="badge-duree" class="text-[10px] font-semibold px-2 py-0.5 rounded-full"></span>
                        </label>
                        <input type="number" id="duree_mois" name="duree_mois" min="1"
                               class="w-full rounded-lg border px-3 py-2.5 text-sm transition field-input"
                               placeholder="Ex: 240 (20 ans)">
                    </div>

                    <div id="group-date-fin">
                        <label class="text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                            <span>Date de fin</span>
                            <span id="badge-date-fin" class="text-[10px] font-semibold px-2 py-0.5 rounded-full"></span>
                        </label>
                        <input type="date" id="date_fin"
                               class="w-full rounded-lg border px-3 py-2.5 text-sm transition field-input">
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-3">Renseignez la duree en mois OU la date de fin. L'autre valeur sera calculee automatiquement.</p>
            </div>
        </div>

        <!-- Section: Credit en cours (optionnel) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-5">
            <div class="px-5 py-3 border-b border-gray-100">
                <h2 class="text-sm font-semibold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    Credit en cours
                    <span class="text-[10px] font-semibold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 ml-1">optionnel</span>
                </h2>
            </div>
            <div class="p-5">
                <p class="text-sm text-gray-500 mb-4">Si vous reprenez un credit en cours et connaissez le capital restant du, renseignez-le. Cela permet de calculer le taux ou le capital initial.</p>
                <div class="max-w-sm">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Capital restant du actuel</label>
                    <div class="relative">
                        <input type="number" id="capital_restant" step="0.01" min="0"
                               class="w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm pr-10 transition focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Capital restant a rembourser">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-gray-400">EUR</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message d'etat -->
        <div id="statusMessage" class="rounded-xl p-4 mb-5 hidden">
            <div class="flex items-center gap-3">
                <span id="statusIcon" class="text-lg"></span>
                <span id="statusText" class="text-sm font-medium"></span>
            </div>
        </div>

        <!-- Resultats -->
        <div id="resultsBox" class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl shadow-lg p-6 mb-6 hidden">
            <h3 class="text-white font-semibold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Recapitulatif du credit
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                <div class="bg-white/15 backdrop-blur rounded-lg p-3">
                    <p class="text-[10px] text-blue-100 uppercase tracking-wider mb-1">Capital</p>
                    <p class="text-lg font-bold text-white" id="result-capital">-</p>
                </div>
                <div class="bg-white/15 backdrop-blur rounded-lg p-3">
                    <p class="text-[10px] text-blue-100 uppercase tracking-wider mb-1">Taux</p>
                    <p class="text-lg font-bold text-white" id="result-taux">-</p>
                </div>
                <div class="bg-white/15 backdrop-blur rounded-lg p-3">
                    <p class="text-[10px] text-blue-100 uppercase tracking-wider mb-1">Duree</p>
                    <p class="text-lg font-bold text-white" id="result-duree">-</p>
                </div>
                <div class="bg-white/15 backdrop-blur rounded-lg p-3">
                    <p class="text-[10px] text-blue-100 uppercase tracking-wider mb-1">Mensualite</p>
                    <p class="text-lg font-bold text-white" id="result-mensualite">-</p>
                </div>
                <div class="bg-white/15 backdrop-blur rounded-lg p-3">
                    <p class="text-[10px] text-blue-100 uppercase tracking-wider mb-1">Cout total</p>
                    <p class="text-lg font-bold text-white" id="result-cout">-</p>
                </div>
                <div class="bg-white/15 backdrop-blur rounded-lg p-3">
                    <p class="text-[10px] text-blue-100 uppercase tracking-wider mb-1">Fin</p>
                    <p class="text-lg font-bold text-white" id="result-date-fin">-</p>
                </div>
            </div>
        </div>

        <!-- Hidden fields pour les valeurs calculees -->
        <input type="hidden" id="hidden_capital" name="capital_emprunte_final">
        <input type="hidden" id="hidden_taux" name="taux_interet_final">
        <input type="hidden" id="hidden_duree" name="duree_mois_final">

        <!-- Boutons -->
        <div class="flex items-center justify-between">
            <button type="button" onclick="clearForm()" class="text-sm text-gray-500 hover:text-gray-700 transition">
                Effacer tout
            </button>
            <div class="flex gap-3">
                <a href="{% url 'app_immeuble_detail' pk=immeuble.pk %}"
                   class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    Annuler
                </a>
                <button type="submit" id="submitBtn" disabled
                        class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition disabled:opacity-40 disabled:cursor-not-allowed shadow-sm">
                    Enregistrer le credit
                </button>
            </div>
        </div>
    </form>
</div>

<style type="text/tailwindcss">
    .field-input {
        border-color: theme('colors.gray.300');
    }
    .field-input:focus {
        --tw-ring-color: theme('colors.blue.500');
        border-color: theme('colors.blue.500');
        outline: none;
        box-shadow: 0 0 0 2px var(--tw-ring-color);
    }
    .field-calculated {
        background-color: #ecfdf5 !important;
        border-color: #10b981 !important;
        color: #065f46 !important;
        font-weight: 600;
    }
    .field-needed {
        background-color: #fffbeb !important;
        border-color: #f59e0b !important;
    }
</style>

<script>
(function() {
    // === State ===
    let calculated = { capital: false, taux: false, duree: false, mensualite: false, dateFin: false };
    let finalValues = {};

    // === Calculation functions ===
    function calcMensualite(capital, taux, duree, type) {
        if (!capital || !duree || taux == null) return null;
        const tm = taux / 100 / 12;
        if (type === 'IN_FINE') return capital * tm;
        if (tm === 0) return capital / duree;
        return capital * (tm * Math.pow(1 + tm, duree)) / (Math.pow(1 + tm, duree) - 1);
    }

    function calcCapital(mensualite, taux, duree, type) {
        if (!mensualite || !duree || taux == null) return null;
        const tm = taux / 100 / 12;
        if (type === 'IN_FINE') return tm > 0 ? mensualite / tm : null;
        if (tm === 0) return mensualite * duree;
        return mensualite * (Math.pow(1 + tm, duree) - 1) / (tm * Math.pow(1 + tm, duree));
    }

    function calcTaux(capital, mensualite, duree, type) {
        if (!capital || !mensualite || !duree) return null;
        if (type === 'IN_FINE') return (mensualite / capital) * 12 * 100;
        // Newton-Raphson
        let t = 0.05;
        for (let i = 0; i < 100; i++) {
            const tm = t / 12;
            if (tm <= 0) { t = 0.001; continue; }
            const mc = capital * (tm * Math.pow(1 + tm, duree)) / (Math.pow(1 + tm, duree) - 1);
            if (Math.abs(mc - mensualite) < 0.0001) return t * 100;
            const eps = 0.0001;
            const mp = capital * ((tm + eps) * Math.pow(1 + tm + eps, duree)) / (Math.pow(1 + tm + eps, duree) - 1);
            const d = (mp - mc) / eps;
            if (d !== 0) t = t - (mc - mensualite) / d;
            if (t < 0) t = 0.001;
        }
        return t * 100;
    }

    function calcDureeFromDates(d1, d2) {
        if (!d1 || !d2) return null;
        const a = new Date(d1), b = new Date(d2);
        const m = (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
        return m > 0 ? m : null;
    }

    function calcDateFin(debut, mois) {
        if (!debut || !mois) return null;
        const d = new Date(debut);
        d.setMonth(d.getMonth() + parseInt(mois));
        return d.toISOString().split('T')[0];
    }

    function calcDureeRestante(dateFin) {
        if (!dateFin) return null;
        const now = new Date(), d = new Date(dateFin);
        const m = (d.getFullYear() - now.getFullYear()) * 12 + (d.getMonth() - now.getMonth());
        return m > 0 ? m : null;
    }

    // === Helpers ===
    function val(id) { const v = document.getElementById(id).value; return v ? parseFloat(v) : null; }
    function strVal(id) { return document.getElementById(id).value || null; }

    function formatEuro(n) { return Math.round(n).toLocaleString('fr-FR') + ' EUR'; }
    function formatDuree(m) {
        const a = Math.floor(m / 12), r = m % 12;
        if (a === 0) return m + ' mois';
        if (r === 0) return a + ' ans';
        return a + 'a ' + r + 'm';
    }
    function formatDate(s) {
        if (!s) return '-';
        return new Date(s).toLocaleDateString('fr-FR');
    }

    function setBadge(id, state) {
        const badge = document.getElementById(id);
        if (!badge) return;
        badge.className = 'text-[10px] font-semibold px-2 py-0.5 rounded-full';
        const input = badge.closest('div').querySelector('.field-input') || badge.closest('div').parentElement.querySelector('.field-input');
        if (input) {
            input.classList.remove('field-calculated', 'field-needed');
        }
        switch (state) {
            case 'filled':
                badge.classList.add('bg-blue-100', 'text-blue-700');
                badge.textContent = 'rempli';
                break;
            case 'calculated':
                badge.classList.add('bg-green-100', 'text-green-700');
                badge.textContent = 'calcule';
                if (input) input.classList.add('field-calculated');
                break;
            case 'needed':
                badge.classList.add('bg-amber-100', 'text-amber-700');
                badge.textContent = 'necessaire';
                if (input) input.classList.add('field-needed');
                break;
            case 'optional':
                badge.classList.add('bg-gray-100', 'text-gray-500');
                badge.textContent = 'optionnel';
                break;
            default:
                badge.textContent = '';
        }
    }

    // === Main calculation logic ===
    function calculate() {
        const type = document.getElementById('type_credit').value;
        calculated = { capital: false, taux: false, duree: false, mensualite: false, dateFin: false };

        // Read user inputs
        let capital = val('capital_emprunte');
        let taux = val('taux_interet');
        let mensualite = val('mensualite');
        let duree = val('duree_mois');
        let dateDebut = strVal('date_debut');
        let dateFin = strVal('date_fin');
        let crd = val('capital_restant');

        // Track what was typed by user
        const userCapital = capital, userTaux = taux, userMensualite = mensualite;
        const userDuree = duree, userDateFin = dateFin;

        // Duration from dates
        if (!duree && dateDebut && dateFin) {
            duree = calcDureeFromDates(dateDebut, dateFin);
            if (duree) { calculated.duree = true; document.getElementById('duree_mois').value = duree; }
        }
        // Date fin from duration
        if (!dateFin && dateDebut && duree) {
            dateFin = calcDateFin(dateDebut, duree);
            if (dateFin) { calculated.dateFin = true; document.getElementById('date_fin').value = dateFin; }
        }

        // CRD-based rate calculation
        if (crd && mensualite && dateFin && taux == null) {
            const dr = calcDureeRestante(dateFin);
            if (dr) {
                taux = calcTaux(crd, mensualite, dr, type);
                if (taux) { calculated.taux = true; document.getElementById('taux_interet').value = taux.toFixed(3); }
            }
        }

        // Standard 3-of-4 calculations
        if (capital && taux != null && duree && !mensualite) {
            mensualite = calcMensualite(capital, taux, duree, type);
            if (mensualite) { calculated.mensualite = true; document.getElementById('mensualite').value = mensualite.toFixed(2); }
        }
        if (mensualite && taux != null && duree && !capital) {
            capital = calcCapital(mensualite, taux, duree, type);
            if (capital) { calculated.capital = true; document.getElementById('capital_emprunte').value = capital.toFixed(2); }
        }
        if (capital && mensualite && duree && taux == null) {
            taux = calcTaux(capital, mensualite, duree, type);
            if (taux != null) { calculated.taux = true; document.getElementById('taux_interet').value = taux.toFixed(3); }
        }

        finalValues = { capital, taux, duree, mensualite, dateDebut, dateFin };

        // Update badges
        setBadge('badge-capital', calculated.capital ? 'calculated' : userCapital ? 'filled' : (taux != null && duree && mensualite) ? 'optional' : 'needed');
        setBadge('badge-taux', calculated.taux ? 'calculated' : userTaux != null ? 'filled' : (capital && duree && mensualite) ? 'optional' : 'needed');
        setBadge('badge-mensualite', calculated.mensualite ? 'calculated' : userMensualite ? 'filled' : (capital && taux != null && duree) ? 'optional' : 'needed');
        setBadge('badge-duree', calculated.duree ? 'calculated' : userDuree ? 'filled' : (dateDebut && userDateFin) ? 'optional' : 'needed');
        setBadge('badge-date-debut', dateDebut ? 'filled' : 'needed');
        setBadge('badge-date-fin', calculated.dateFin ? 'calculated' : userDateFin ? 'filled' : 'optional');

        // Update results and status
        updateResults();
    }

    function updateResults() {
        const { capital, taux, duree, mensualite, dateDebut, dateFin } = finalValues;
        const assurance = parseFloat(document.getElementById('assurance_mensuelle').value) || 0;
        const banque = document.getElementById('nom_banque').value.trim();
        const isComplete = capital && taux != null && duree && mensualite && dateDebut && banque;

        const statusEl = document.getElementById('statusMessage');
        const resultsEl = document.getElementById('resultsBox');
        const submitBtn = document.getElementById('submitBtn');

        if (isComplete) {
            submitBtn.disabled = false;
            resultsEl.classList.remove('hidden');

            const mensTotale = mensualite + assurance;
            const coutTotal = mensTotale * duree;

            document.getElementById('result-capital').textContent = formatEuro(capital);
            document.getElementById('result-taux').textContent = taux.toFixed(2) + ' %';
            document.getElementById('result-duree').textContent = formatDuree(duree);
            document.getElementById('result-mensualite').textContent = formatEuro(mensTotale);
            document.getElementById('result-cout').textContent = formatEuro(coutTotal);
            document.getElementById('result-date-fin').textContent = formatDate(dateFin);

            document.getElementById('hidden_capital').value = capital.toFixed(2);
            document.getElementById('hidden_taux').value = taux.toFixed(3);
            document.getElementById('hidden_duree').value = duree;

            statusEl.className = 'rounded-xl p-4 mb-5 bg-green-50 border border-green-200';
            document.getElementById('statusIcon').textContent = '\u2713';
            document.getElementById('statusText').textContent = 'Toutes les donnees sont completes. Vous pouvez enregistrer le credit.';
            document.getElementById('statusText').className = 'text-sm font-medium text-green-800';
            document.getElementById('statusIcon').className = 'text-lg text-green-600';
            statusEl.classList.remove('hidden');
        } else {
            submitBtn.disabled = true;
            resultsEl.classList.add('hidden');

            let missing = [];
            if (!dateDebut) missing.push('date de debut');
            if (!duree) missing.push('duree ou date de fin');
            if (!capital) missing.push('capital');
            if (taux == null) missing.push('taux');
            if (!mensualite) missing.push('mensualite');
            if (!banque) missing.push('nom de la banque');

            if (missing.length > 0 && missing.length < 6) {
                statusEl.className = 'rounded-xl p-4 mb-5 bg-amber-50 border border-amber-200';
                document.getElementById('statusIcon').textContent = '!';
                document.getElementById('statusIcon').className = 'text-lg text-amber-600';
                document.getElementById('statusText').textContent = 'Manquant : ' + missing.join(', ');
                document.getElementById('statusText').className = 'text-sm font-medium text-amber-800';
                statusEl.classList.remove('hidden');
            } else {
                statusEl.classList.add('hidden');
            }
        }
    }

    function clearForm() {
        ['capital_emprunte', 'taux_interet', 'mensualite', 'duree_mois',
         'date_debut', 'date_fin', 'capital_restant', 'nom_banque', 'numero_pret'].forEach(function(id) {
            document.getElementById(id).value = '';
        });
        document.getElementById('assurance_mensuelle').value = '0';
        calculate();
    }
    window.clearForm = clearForm;

    // === Event listeners ===
    document.querySelectorAll('#creditForm input[type="number"], #creditForm input[type="date"], #creditForm input[type="text"], #creditForm select').forEach(function(el) {
        el.addEventListener('input', calculate);
        el.addEventListener('change', calculate);
    });

    // === Form validation ===
    document.getElementById('creditForm').addEventListener('submit', function(e) {
        const { capital, taux, duree, dateDebut } = finalValues;
        const banque = document.getElementById('nom_banque').value.trim();
        if (!capital || taux == null || !duree || !dateDebut || !banque) {
            e.preventDefault();
            return false;
        }
        // Set final values in form fields for POST
        document.getElementById('capital_emprunte').value = capital.toFixed(2);
        document.getElementById('taux_interet').value = taux.toFixed(3);
        document.getElementById('duree_mois').value = duree;
    });

    // Init
    calculate();
})();
</script>
{% endblock %}
