{% extends "app/base.html" %}
{% load app_filters %}

{% block title %}Bilan fiscal {{ annee }} - {{ immeuble.nom }}{% endblock %}
{% block page_title %}Bilan fiscal {{ annee }}{% endblock %}

{% block header_actions %}
<div class="ml-auto flex items-center gap-3">
    <form method="get" class="flex items-center gap-2">
        <select name="annee" onchange="this.form.submit()"
                class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            {% for a in annees_disponibles %}
            <option value="{{ a }}" {% if a == annee %}selected{% endif %}>{{ a }}</option>
            {% endfor %}
        </select>
    </form>
    <a href="{% url 'app_patrimoine' %}" class="text-sm text-gray-500 hover:text-gray-700">
        &larr; Patrimoine
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="mb-6 text-sm text-gray-500">
    <a href="{% url 'app_patrimoine' %}" class="hover:text-blue-600">Patrimoine</a>
    <span class="mx-1">/</span>
    <a href="{% url 'app_immeuble_detail' pk=immeuble.pk %}" class="hover:text-blue-600">{{ immeuble.nom }}</a>
    <span class="mx-1">/</span>
    <span class="text-gray-900">Bilan fiscal {{ annee }}</span>
</div>

<!-- Info regime -->
<div class="mb-6 bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-center gap-3">
    <svg class="w-5 h-5 text-blue-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <p class="text-sm text-blue-800">
        Regime fiscal : <span class="font-semibold">{{ bilan.regime_fiscal }}</span>
        &mdash; {{ immeuble.nom }} ({{ immeuble.ville }})
    </p>
</div>

<!-- Synthese KPIs -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <p class="text-xs text-gray-500 mb-1">Revenus bruts</p>
        <p class="text-lg font-bold text-green-600">{{ bilan.revenus.loyers_bruts|euro }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <p class="text-xs text-gray-500 mb-1">Total charges deductibles</p>
        <p class="text-lg font-bold text-red-600">{{ bilan.resultat.total_charges|euro }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <p class="text-xs text-gray-500 mb-1">Resultat foncier</p>
        <p class="text-lg font-bold {% if bilan.resultat.resultat_foncier >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
            {{ bilan.resultat.resultat_foncier|euro }}
        </p>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <p class="text-xs text-gray-500 mb-1">Deficit reportable</p>
        <p class="text-lg font-bold {% if bilan.resultat.deficit_reportable < 0 %}text-orange-600{% else %}text-gray-400{% endif %}">
            {% if bilan.resultat.deficit_reportable < 0 %}{{ bilan.resultat.deficit_reportable|euro }}{% else %}Aucun{% endif %}
        </p>
    </div>
</div>

<!-- Detail Revenus -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
    <div class="px-5 py-4 border-b border-gray-200">
        <h3 class="text-sm font-semibold text-gray-700">Revenus (ligne 211)</h3>
    </div>
    <div class="p-5">
        <div class="flex items-center justify-between py-2">
            <span class="text-sm text-gray-600">Loyers bruts encaisses</span>
            <span class="text-sm font-semibold text-gray-900">{{ bilan.revenus.loyers_bruts|euro }}</span>
        </div>
    </div>
</div>

<!-- Detail Credits / Interets -->
{% if credits_details %}
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
    <div class="px-5 py-4 border-b border-gray-200">
        <h3 class="text-sm font-semibold text-gray-700">Interets d'emprunt (ligne 250)</h3>
    </div>
    <div class="p-5">
        <!-- Vue mobile -->
        <div class="space-y-3 lg:hidden">
            {% for c in credits_details %}
            <div class="border border-gray-200 rounded-lg p-3">
                <p class="font-medium text-gray-900 mb-1">{{ c.banque }}</p>
                <div class="text-sm text-gray-600 space-y-0.5">
                    <p>{{ c.nb_echeances }} echeances</p>
                    <p>Interets : <span class="font-medium text-gray-900">{{ c.interets|euro }}</span></p>
                    <p>Assurance : <span class="font-medium text-gray-900">{{ c.assurance|euro }}</span></p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Vue desktop -->
        <div class="hidden lg:block">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Banque</th>
                        <th class="text-right py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Echeances</th>
                        <th class="text-right py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Interets</th>
                        <th class="text-right py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Assurance</th>
                        <th class="text-right py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Total</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for c in credits_details %}
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-3 text-sm font-medium text-gray-900">{{ c.banque }}</td>
                        <td class="py-2 px-3 text-sm text-right text-gray-600">{{ c.nb_echeances }}</td>
                        <td class="py-2 px-3 text-sm text-right text-gray-900">{{ c.interets|euro }}</td>
                        <td class="py-2 px-3 text-sm text-right text-gray-900">{{ c.assurance|euro }}</td>
                        <td class="py-2 px-3 text-sm text-right font-semibold text-gray-900">{{ c.total|euro }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="border-t-2 border-gray-300">
                        <td class="py-2 px-3 text-sm font-semibold text-gray-900" colspan="2">Total</td>
                        <td class="py-2 px-3 text-sm text-right font-semibold text-gray-900">{{ total_interets|euro }}</td>
                        <td class="py-2 px-3 text-sm text-right font-semibold text-gray-900">{{ total_assurance|euro }}</td>
                        <td class="py-2 px-3 text-sm text-right font-bold text-red-600">{{ bilan.charges.interets_emprunts|euro }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Charges deductibles manuelles -->
{% if charges_par_type %}
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
    <div class="px-5 py-4 border-b border-gray-200">
        <h3 class="text-sm font-semibold text-gray-700">Charges deductibles (lignes 221-227)</h3>
    </div>
    <div class="p-5 space-y-4">
        {% for type_display, charges_list in charges_par_type.items %}
        <div>
            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">{{ type_display }}</h4>
            <div class="space-y-1">
                {% for charge in charges_list %}
                <div class="flex items-center justify-between py-1.5 px-3 rounded-lg hover:bg-gray-50">
                    <span class="text-sm text-gray-700">{{ charge.libelle }}</span>
                    <span class="text-sm font-medium text-gray-900">{{ charge.montant|euro }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <div class="border-t-2 border-gray-300 pt-3 flex items-center justify-between">
            <span class="text-sm font-semibold text-gray-900">Total charges manuelles</span>
            <span class="text-sm font-bold text-red-600">{{ bilan.charges.total_charges_deductibles|euro }}</span>
        </div>
    </div>
</div>
{% endif %}

<!-- Recapitulatif declaration 2044 -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
    <div class="px-5 py-4 border-b border-gray-200 bg-gray-50">
        <h3 class="text-sm font-semibold text-gray-700">Recapitulatif - Declaration 2044</h3>
    </div>
    <div class="p-5 space-y-2">
        <div class="flex items-center justify-between py-2">
            <span class="text-sm text-gray-600">Revenus bruts</span>
            <span class="text-sm font-medium text-green-600">+ {{ bilan.revenus.loyers_bruts|euro }}</span>
        </div>
        {% if bilan.charges.total_charges_deductibles %}
        <div class="flex items-center justify-between py-2">
            <span class="text-sm text-gray-600">Charges deductibles</span>
            <span class="text-sm font-medium text-red-600">- {{ bilan.charges.total_charges_deductibles|euro }}</span>
        </div>
        {% endif %}
        {% if bilan.charges.interets_emprunts %}
        <div class="flex items-center justify-between py-2">
            <span class="text-sm text-gray-600">Interets d'emprunt</span>
            <span class="text-sm font-medium text-red-600">- {{ bilan.charges.interets_emprunts|euro }}</span>
        </div>
        {% endif %}
        {% if bilan.charges.assurance_emprunt %}
        <div class="flex items-center justify-between py-2">
            <span class="text-sm text-gray-600">Assurance emprunt</span>
            <span class="text-sm font-medium text-red-600">- {{ bilan.charges.assurance_emprunt|euro }}</span>
        </div>
        {% endif %}
        <div class="border-t-2 border-gray-300 pt-3 flex items-center justify-between">
            <span class="text-sm font-bold text-gray-900">Resultat foncier {{ annee }}</span>
            <span class="text-lg font-bold {% if bilan.resultat.resultat_foncier >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {{ bilan.resultat.resultat_foncier|euro }}
            </span>
        </div>
        {% if bilan.resultat.deficit_reportable < 0 %}
        <div class="mt-2 bg-orange-50 border border-orange-200 rounded-lg p-3">
            <p class="text-sm text-orange-800">
                <span class="font-semibold">Deficit foncier :</span> {{ bilan.resultat.deficit_reportable|euro }}
                &mdash; imputable sur le revenu global dans la limite de 10 700 EUR/an (hors interets d'emprunt).
            </p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
